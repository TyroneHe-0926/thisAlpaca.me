import { Directive, Input, Renderer2, ElementRef } from '@angular/core';
import { ScrollService } from './scroll.service';
import { Subscription } from 'rxjs';
export class AnimateOnScrollDirective {
    constructor(elementRef, renderer, scroll) {
        this.elementRef = elementRef;
        this.renderer = renderer;
        this.scroll = scroll;
        this.scrollSub = new Subscription();
        this.resizeSub = new Subscription();
        // Pixel offset from screen bottom to the animated element to determine the start of the animation
        this.offset = 80; // for scroll Listener
    }
    get id() {
        return this.elementRef.nativeElement.id;
    }
    ngOnInit() {
        if (!this.animationName) {
            return;
        }
        // default visibility to false
        this.isVisible = false;
        this.useScroll = this.useScroll ? this.useScroll : ((this.useScroll === false) ? false : true);
        this.threshold = this.threshold ? (this.threshold || 0.5) : 0.5;
        // using intersecting observer by default, else fallback to scroll Listener
        if ('IntersectionObserver' in window && this.useScroll) {
            const options = {
                root: null,
                threshold: this.threshold,
                rootMargin: '0px'
            };
            const observer = new IntersectionObserver((entries, _) => {
                entries.forEach(entry => {
                    if (!entry.isIntersecting) {
                        return;
                    }
                    this.addAnimationClass();
                });
            }, options);
            observer.observe(this.elementRef.nativeElement);
            return;
        }
        // subscribe to scroll event using service
        this.scrollSub = this.scroll.scrollObs
            .subscribe(() => this.manageVisibility());
        // subscribe to resize event using service so scrolling position is always accurate
        this.resizeSub = this.scroll.resizeObs
            .subscribe(() => this.manageVisibility());
    }
    ngAfterViewInit() {
        // run visibility check initially in case the element is already visible in viewport
        setTimeout(() => this.manageVisibility(), 1);
    }
    ngOnDestroy() {
        this.scrollSub.unsubscribe();
        this.resizeSub.unsubscribe();
    }
    /**
     * check for visibility of element in viewport to add animation
     *
     * @returns void
     */
    manageVisibility() {
        if (this.isVisible) {
            // Optimisation; nothing to do if class has already been applied
            return;
        }
        // check for window height, may change with a window resize
        this.getWinHeight();
        // get vertical position for selected element
        this.getOffsetTop();
        // we should trigger the addition of the animation class a little after getting to the element
        const scrollTrigger = this.offsetTop + this.offset - this.winHeight;
        // using values updated in service
        if (this.scroll.pos >= scrollTrigger) {
            this.addAnimationClass();
        }
    }
    /**
     * utility function to mark element visible and add css class
     *
     * @returns void
     */
    addAnimationClass() {
        // stops execution if no class is provided
        if (!this.animationName) {
            return;
        }
        // mark this element visible, we won't remove the class after this
        this.isVisible = true;
        // use default for animate.css if no value provided
        this.setClass(this.animationName);
    }
    /**
     * utility function to add one or more css classes to element in DOM
     *
     * @param  {string} classes
     * @returns void
     */
    setClass(classes) {
        for (const c of classes.split(' ')) {
            this.renderer.addClass(this.elementRef.nativeElement, c);
        }
    }
    /**
     * get window height utility function
     *
     * @returns void
     */
    getWinHeight() {
        this.winHeight = typeof window !== 'undefined' ? window.innerHeight : 0;
    }
    /**
     * get offsetTop value for element
     *
     * @returns void
     */
    getOffsetTop() {
        if (typeof this.elementRef.nativeElement.getBoundingClientRect === 'function') {
            const viewportTop = this.elementRef.nativeElement.getBoundingClientRect().top;
            const clientTop = this.elementRef.nativeElement.clientTop;
            // get vertical position for selected element
            this.offsetTop = viewportTop + this.scroll.pos - clientTop;
        }
        else {
            this.offsetTop = 0;
        }
    }
}
AnimateOnScrollDirective.decorators = [
    { type: Directive, args: [{
                selector: '[animateOnScroll]'
            },] }
];
AnimateOnScrollDirective.ctorParameters = () => [
    { type: ElementRef },
    { type: Renderer2 },
    { type: ScrollService }
];
AnimateOnScrollDirective.propDecorators = {
    animationName: [{ type: Input }],
    offset: [{ type: Input }],
    useScroll: [{ type: Input }],
    threshold: [{ type: Input }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYW5pbWF0ZS1vbi1zY3JvbGwuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uL3Byb2plY3RzL25nMi1hbmltYXRlLW9uLXNjcm9sbC9zcmMvIiwic291cmNlcyI6WyJsaWIvYW5pbWF0ZS1vbi1zY3JvbGwuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxVQUFVLEVBQW9DLE1BQU0sZUFBZSxDQUFDO0FBQzFHLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUNqRCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBS3BDLE1BQU0sT0FBTyx3QkFBd0I7SUFrQm5DLFlBQW9CLFVBQXNCLEVBQVUsUUFBbUIsRUFBVSxNQUFxQjtRQUFsRixlQUFVLEdBQVYsVUFBVSxDQUFZO1FBQVUsYUFBUSxHQUFSLFFBQVEsQ0FBVztRQUFVLFdBQU0sR0FBTixNQUFNLENBQWU7UUFiOUYsY0FBUyxHQUFpQixJQUFJLFlBQVksRUFBRSxDQUFDO1FBQzdDLGNBQVMsR0FBaUIsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQU9yRCxrR0FBa0c7UUFDekYsV0FBTSxHQUFXLEVBQUUsQ0FBQyxDQUFDLHNCQUFzQjtJQUlzRCxDQUFDO0lBVjNHLElBQVksRUFBRTtRQUNaLE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQyxhQUFhLENBQUMsRUFBRSxDQUFDO0lBQzFDLENBQUM7SUFVRCxRQUFRO1FBQ04sSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUU7WUFDdkIsT0FBTztTQUNSO1FBQ0QsOEJBQThCO1FBQzlCLElBQUksQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLElB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QUssTUFBTSxDQUFDLElBQUksT0FBTyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsRUFBRTtZQUNsQyxJQUFJLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLGFBQWEsRUFBRSxDQUFDLENBQUMsQ0FBQztTQUMxRDtJQUVILENBQUM7SUFFRDs7OztPQUlHO0lBQ0ssWUFBWTtRQUVsQixJQUFJLENBQUMsU0FBUyxHQUFHLE9BQU8sTUFBTSxLQUFLLFdBQVcsQ0FBQyxDQUFDLENBQUUsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRTNFLENBQUM7SUFFRDs7OztPQUlHO0lBQ0ssWUFBWTtRQUNsQixJQUFJLE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQyxhQUFhLENBQUMscUJBQXFCLEtBQUssVUFBVSxFQUFFO1lBQzdFLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsYUFBYSxDQUFDLHFCQUFxQixFQUFFLENBQUMsR0FBRyxDQUFDO1lBQzlFLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsYUFBYSxDQUFDLFNBQVMsQ0FBQztZQUUxRCw2Q0FBNkM7WUFDN0MsSUFBSSxDQUFDLFNBQVMsR0FBRyxXQUFXLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLEdBQUcsU0FBUyxDQUFDO1NBQzVEO2FBQU07WUFDTCxJQUFJLENBQUMsU0FBUyxHQUFHLENBQUMsQ0FBQztTQUNwQjtJQUVILENBQUM7OztZQTlKRixTQUFTLFNBQUM7Z0JBQ1QsUUFBUSxFQUFFLG1CQUFtQjthQUM5Qjs7O1lBTnFDLFVBQVU7WUFBckIsU0FBUztZQUMzQixhQUFhOzs7NEJBa0JuQixLQUFLO3FCQUVMLEtBQUs7d0JBQ0wsS0FBSzt3QkFDTCxLQUFLIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGlyZWN0aXZlLCBJbnB1dCwgUmVuZGVyZXIyLCBFbGVtZW50UmVmLCBPbkluaXQsIE9uRGVzdHJveSwgQWZ0ZXJWaWV3SW5pdCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgU2Nyb2xsU2VydmljZSB9IGZyb20gJy4vc2Nyb2xsLnNlcnZpY2UnO1xuaW1wb3J0IHsgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XG5cbkBEaXJlY3RpdmUoe1xuICBzZWxlY3RvcjogJ1thbmltYXRlT25TY3JvbGxdJ1xufSlcbmV4cG9ydCBjbGFzcyBBbmltYXRlT25TY3JvbGxEaXJlY3RpdmUgaW1wbGVtZW50cyBPbkluaXQsIE9uRGVzdHJveSwgQWZ0ZXJWaWV3SW5pdCB7XG5cbiAgcHJpdmF0ZSBvZmZzZXRUb3A6IG51bWJlcjtcbiAgcHJpdmF0ZSBpc1Zpc2libGU6IGJvb2xlYW47XG4gIHByaXZhdGUgd2luSGVpZ2h0OiBudW1iZXI7XG4gIHByaXZhdGUgc2Nyb2xsU3ViOiBTdWJzY3JpcHRpb24gPSBuZXcgU3Vic2NyaXB0aW9uKCk7XG4gIHByaXZhdGUgcmVzaXplU3ViOiBTdWJzY3JpcHRpb24gPSBuZXcgU3Vic2NyaXB0aW9uKCk7XG5cbiAgcHJpdmF0ZSBnZXQgaWQoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQuaWQ7XG4gIH1cblxuICBASW5wdXQoKSBhbmltYXRpb25OYW1lOiBzdHJpbmcgfCBudWxsOyAvLyB1c2UgZmFkZUluIGFzIGRlZmF1bHQgaWYgbm90IHNwZWNpZmllZCwgc3BlY2lmeSBudWxsIGZvciBubyBhbmltYXRpb25cbiAgLy8gUGl4ZWwgb2Zmc2V0IGZyb20gc2NyZWVuIGJvdHRvbSB0byB0aGUgYW5pbWF0ZWQgZWxlbWVudCB0byBkZXRlcm1pbmUgdGhlIHN0YXJ0IG9mIHRoZSBhbmltYXRpb25cbiAgQElucHV0KCkgb2Zmc2V0OiBudW1iZXIgPSA4MDsgLy8gZm9yIHNjcm9sbCBMaXN0ZW5lclxuICBASW5wdXQoKSB1c2VTY3JvbGw/OiBib29sZWFuO1xuICBASW5wdXQoKSB0aHJlc2hvbGQgPzogbnVtYmVyOyAvLyBmb3IgaW50ZXJzZWN0aW9uIG9ic2VydmVyIG9ubHkgZm9yIHRoZSB0aW1lIGJlaW5nXG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBlbGVtZW50UmVmOiBFbGVtZW50UmVmLCBwcml2YXRlIHJlbmRlcmVyOiBSZW5kZXJlcjIsIHByaXZhdGUgc2Nyb2xsOiBTY3JvbGxTZXJ2aWNlKSB7IH1cblxuICBuZ09uSW5pdCgpOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMuYW5pbWF0aW9uTmFtZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICAvLyBkZWZhdWx0IHZpc2liaWxpdHkgdG8gZmFsc2VcbiAgICB0aGlzLmlzVmlzaWJsZSA9IGZhbHNlO1xuICAgIHRoaXMudXNlU2Nyb2xsID0gdGhpcy51c2VTY3JvbGwgPyB0aGlzLnVzZVNjcm9sbCA6ICgodGhpcy51c2VTY3JvbGwgPT09IGZhbHNlKSA/IGZhbHNlIDogdHJ1ZSk7XG4gICAgdGhpcy50aHJlc2hvbGQgPSB0aGlzLnRocmVzaG9sZCA/ICh0aGlzLnRocmVzaG9sZCB8fCAwLjUpIDogMC41O1xuICAgIC8vIHVzaW5nIGludGVyc2VjdGluZyBvYnNlcnZlciBieSBkZWZhdWx0LCBlbHNlIGZhbGxiYWNrIHRvIHNjcm9sbCBMaXN0ZW5lclxuICAgIGlmICgnSW50ZXJzZWN0aW9uT2JzZXJ2ZXInIGluIHdpbmRvdyAmJiB0aGlzLnVzZVNjcm9sbCkge1xuICAgICAgY29uc3Qgb3B0aW9uczogSW50ZXJzZWN0aW9uT2JzZXJ2ZXJJbml0ID0ge1xuICAgICAgICByb290OiBudWxsLFxuICAgICAgICB0aHJlc2hvbGQ6IHRoaXMudGhyZXNob2xkLFxuICAgICAgICByb290TWFyZ2luOiAnMHB4J1xuICAgICAgfTtcbiAgICAgIGNvbnN0IG9ic2VydmVyOiBJbnRlcnNlY3Rpb25PYnNlcnZlciA9IG5ldyBJbnRlcnNlY3Rpb25PYnNlcnZlcigoZW50cmllcywgXykgPT4ge1xuICAgICAgICBlbnRyaWVzLmZvckVhY2goZW50cnkgPT4ge1xuICAgICAgICAgIGlmICghZW50cnkuaXNJbnRlcnNlY3RpbmcpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICB9XG4gICAgICAgICAgdGhpcy5hZGRBbmltYXRpb25DbGFzcygpO1xuICAgICAgICB9KTtcbiAgICAgIH0sIG9wdGlvbnMpO1xuICAgICAgb2JzZXJ2ZXIub2JzZXJ2ZSh0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gc3Vic2NyaWJlIHRvIHNjcm9sbCBldmVudCB1c2luZyBzZXJ2aWNlXG4gICAgdGhpcy5zY3JvbGxTdWIgPSB0aGlzLnNjcm9sbC5zY3JvbGxPYnNcbiAgICAgIC5zdWJzY3JpYmUoKCkgPT4gdGhpcy5tYW5hZ2VWaXNpYmlsaXR5KCkpO1xuXG4gICAgLy8gc3Vic2NyaWJlIHRvIHJlc2l6ZSBldmVudCB1c2luZyBzZXJ2aWNlIHNvIHNjcm9sbGluZyBwb3NpdGlvbiBpcyBhbHdheXMgYWNjdXJhdGVcbiAgICB0aGlzLnJlc2l6ZVN1YiA9IHRoaXMuc2Nyb2xsLnJlc2l6ZU9ic1xuICAgICAgLnN1YnNjcmliZSgoKSA9PiB0aGlzLm1hbmFnZVZpc2liaWxpdHkoKSk7XG5cbiAgfVxuXG4gIG5nQWZ0ZXJWaWV3SW5pdCgpOiB2b2lkIHtcbiAgICAvLyBydW4gdmlzaWJpbGl0eSBjaGVjayBpbml0aWFsbHkgaW4gY2FzZSB0aGUgZWxlbWVudCBpcyBhbHJlYWR5IHZpc2libGUgaW4gdmlld3BvcnRcbiAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMubWFuYWdlVmlzaWJpbGl0eSgpLCAxKTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgIHRoaXMuc2Nyb2xsU3ViLnVuc3Vic2NyaWJlKCk7XG4gICAgdGhpcy5yZXNpemVTdWIudW5zdWJzY3JpYmUoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBjaGVjayBmb3IgdmlzaWJpbGl0eSBvZiBlbGVtZW50IGluIHZpZXdwb3J0IHRvIGFkZCBhbmltYXRpb25cbiAgICpcbiAgICogQHJldHVybnMgdm9pZFxuICAgKi9cbiAgcHJpdmF0ZSBtYW5hZ2VWaXNpYmlsaXR5KCk6IHZvaWQge1xuXG4gICAgaWYgKHRoaXMuaXNWaXNpYmxlKSB7XG4gICAgICAvLyBPcHRpbWlzYXRpb247IG5vdGhpbmcgdG8gZG8gaWYgY2xhc3MgaGFzIGFscmVhZHkgYmVlbiBhcHBsaWVkXG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gY2hlY2sgZm9yIHdpbmRvdyBoZWlnaHQsIG1heSBjaGFuZ2Ugd2l0aCBhIHdpbmRvdyByZXNpemVcbiAgICB0aGlzLmdldFdpbkhlaWdodCgpO1xuXG4gICAgLy8gZ2V0IHZlcnRpY2FsIHBvc2l0aW9uIGZvciBzZWxlY3RlZCBlbGVtZW50XG4gICAgdGhpcy5nZXRPZmZzZXRUb3AoKTtcblxuICAgIC8vIHdlIHNob3VsZCB0cmlnZ2VyIHRoZSBhZGRpdGlvbiBvZiB0aGUgYW5pbWF0aW9uIGNsYXNzIGEgbGl0dGxlIGFmdGVyIGdldHRpbmcgdG8gdGhlIGVsZW1lbnRcbiAgICBjb25zdCBzY3JvbGxUcmlnZ2VyID0gdGhpcy5vZmZzZXRUb3AgKyB0aGlzLm9mZnNldCAtIHRoaXMud2luSGVpZ2h0O1xuXG4gICAgLy8gdXNpbmcgdmFsdWVzIHVwZGF0ZWQgaW4gc2VydmljZVxuICAgIGlmICh0aGlzLnNjcm9sbC5wb3MgPj0gc2Nyb2xsVHJpZ2dlcikge1xuICAgICAgdGhpcy5hZGRBbmltYXRpb25DbGFzcygpO1xuICAgIH1cblxuICB9XG5cbiAgLyoqXG4gICAqIHV0aWxpdHkgZnVuY3Rpb24gdG8gbWFyayBlbGVtZW50IHZpc2libGUgYW5kIGFkZCBjc3MgY2xhc3NcbiAgICpcbiAgICogQHJldHVybnMgdm9pZFxuICAgKi9cbiAgcHJpdmF0ZSBhZGRBbmltYXRpb25DbGFzcygpOiB2b2lkIHtcbiAgICAvLyBzdG9wcyBleGVjdXRpb24gaWYgbm8gY2xhc3MgaXMgcHJvdmlkZWRcbiAgICBpZiAoIXRoaXMuYW5pbWF0aW9uTmFtZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIG1hcmsgdGhpcyBlbGVtZW50IHZpc2libGUsIHdlIHdvbid0IHJlbW92ZSB0aGUgY2xhc3MgYWZ0ZXIgdGhpc1xuICAgIHRoaXMuaXNWaXNpYmxlID0gdHJ1ZTtcblxuICAgIC8vIHVzZSBkZWZhdWx0IGZvciBhbmltYXRlLmNzcyBpZiBubyB2YWx1ZSBwcm92aWRlZFxuICAgIHRoaXMuc2V0Q2xhc3ModGhpcy5hbmltYXRpb25OYW1lKTtcblxuICB9XG5cbiAgLyoqXG4gICAqIHV0aWxpdHkgZnVuY3Rpb24gdG8gYWRkIG9uZSBvciBtb3JlIGNzcyBjbGFzc2VzIHRvIGVsZW1lbnQgaW4gRE9NXG4gICAqXG4gICAqIEBwYXJhbSAge3N0cmluZ30gY2xhc3Nlc1xuICAgKiBAcmV0dXJucyB2b2lkXG4gICAqL1xuICBwcml2YXRlIHNldENsYXNzKGNsYXNzZXM6IHN0cmluZyk6IHZvaWQge1xuXG4gICAgZm9yIChjb25zdCBjIG9mIGNsYXNzZXMuc3BsaXQoJyAnKSkge1xuICAgICAgdGhpcy5yZW5kZXJlci5hZGRDbGFzcyh0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudCwgYyk7XG4gICAgfVxuXG4gIH1cblxuICAvKipcbiAgICogZ2V0IHdpbmRvdyBoZWlnaHQgdXRpbGl0eSBmdW5jdGlvblxuICAgKlxuICAgKiBAcmV0dXJucyB2b2lkXG4gICAqL1xuICBwcml2YXRlIGdldFdpbkhlaWdodCgpOiB2b2lkIHtcblxuICAgIHRoaXMud2luSGVpZ2h0ID0gdHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcgPyAgd2luZG93LmlubmVySGVpZ2h0IDogMDtcblxuICB9XG5cbiAgLyoqXG4gICAqIGdldCBvZmZzZXRUb3AgdmFsdWUgZm9yIGVsZW1lbnRcbiAgICpcbiAgICogQHJldHVybnMgdm9pZFxuICAgKi9cbiAgcHJpdmF0ZSBnZXRPZmZzZXRUb3AoKTogdm9pZCB7XG4gICAgaWYgKHR5cGVvZiB0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgIGNvbnN0IHZpZXdwb3J0VG9wID0gdGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkudG9wO1xuICAgICAgY29uc3QgY2xpZW50VG9wID0gdGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQuY2xpZW50VG9wO1xuXG4gICAgICAvLyBnZXQgdmVydGljYWwgcG9zaXRpb24gZm9yIHNlbGVjdGVkIGVsZW1lbnRcbiAgICAgIHRoaXMub2Zmc2V0VG9wID0gdmlld3BvcnRUb3AgKyB0aGlzLnNjcm9sbC5wb3MgLSBjbGllbnRUb3A7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMub2Zmc2V0VG9wID0gMDtcbiAgICB9XG5cbiAgfVxuXG59XG4iXX0=